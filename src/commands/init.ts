import path from 'node:path';
import fs from 'node:fs/promises';
import { existsSync } from 'node:fs';
import { checkbox, confirm, select } from '@inquirer/prompts';
import { ensureDir } from '@/utils/fs.js';
import type { Locale } from '@/types/index.js';
import { isChineseLocale } from '@/utils/locale.js';

// è‹±æ–‡æŠ€èƒ½æ¨¡æ¿
const TEMPLATE_SKILL_EN = `---
name: Example Skill
description: This is an example skill generated by Skillink.
---

# Usage

Enable this skill to use it.
`;

// ä¸­æ–‡æŠ€èƒ½æ¨¡æ¿
const TEMPLATE_SKILL_ZH = `---
name: ç¤ºä¾‹æŠ€èƒ½
description: è¿™æ˜¯ä¸€ä¸ªç”± Skillink ç”Ÿæˆçš„æ¼”ç¤ºæŠ€èƒ½ã€‚
---

# ä½¿ç”¨è¯´æ˜

æ¿€æ´»æ­¤æŠ€èƒ½å³å¯ä½¿ç”¨ã€‚
`;

// é»˜è®¤æ”¯æŒçš„ç›®æ ‡å·¥å…·
const DEFAULT_TARGETS = [
  { name: 'Cursor', value: 'cursor', path: '.cursor/rules' },
  { name: 'Windsurf', value: 'windsurf', path: '.windsurf/rules' },
  { name: 'VSCode', value: 'vscode', path: '.vscode/skills' },
  { name: 'Gemini', value: 'gemini', path: '.gemini/skills' },
];

function getInitText(locale: Locale) {
  if (isChineseLocale(locale)) {
    return {
      title: 'âœ¨ Skillink åˆå§‹åŒ–',
      createSkillsDir: (skillsDir: string) =>
        `æ˜¯å¦åœ¨ ${skillsDir} åˆ›å»ºæŠ€èƒ½ç›®å½•ï¼Ÿ`,
      exampleSkillCreated: 'âœ… å·²åˆ›å»ºç¤ºä¾‹æŠ€èƒ½ã€‚',
      skillsDirExists: 'â„¹ï¸  æŠ€èƒ½ç›®å½•å·²å­˜åœ¨ã€‚',
      selectTargets: 'é€‰æ‹©è¦åŒæ­¥çš„ AI å·¥å…·ï¼š',
      noTargets: 'âš ï¸ æœªé€‰æ‹©ä»»ä½•ç›®æ ‡ã€‚é…ç½®æ–‡ä»¶ä¸­çš„ç›®æ ‡åˆ—è¡¨å°†ä¸ºç©ºã€‚',
      overwriteConfig: 'é…ç½®æ–‡ä»¶å·²å­˜åœ¨ã€‚æ˜¯å¦è¦†ç›–ï¼Ÿ',
      initCancelled: 'âŒ åˆå§‹åŒ–å·²å–æ¶ˆã€‚',
      configCreated: 'âœ… å·²åˆ›å»º skillink.config.ts',
      gitAdvice: (paths: string) =>
        `ğŸ’¡ Git å»ºè®®ï¼šè¯·å°†ç›®æ ‡ç›®å½•ï¼ˆ${paths}ï¼‰åŠ å…¥ .gitignoreï¼Œåªæäº¤ .agents/skills ä¸é…ç½®æ–‡ä»¶ã€‚`,
      nextStep: '\nğŸ‘‰ è¿è¡Œ "npx skillink sync" å¼€å§‹åŒæ­¥ï¼',
    };
  }

  return {
    title: 'âœ¨ Skillink Initialization',
    createSkillsDir: (skillsDir: string) =>
      `Create skills directory at ${skillsDir}?`,
    exampleSkillCreated: 'âœ… Example skill created.',
    skillsDirExists: 'â„¹ï¸  Skills directory already exists.',
    selectTargets: 'Select AI tools to sync:',
    noTargets:
      'âš ï¸ No targets selected. The config will contain an empty targets list.',
    overwriteConfig: 'Configuration file already exists. Overwrite?',
    initCancelled: 'âŒ Initialization cancelled.',
    configCreated: 'âœ… Created skillink.config.ts',
    gitAdvice: (paths: string) =>
      `ğŸ’¡ Git tip: Add target directories (${paths}) to .gitignore. Commit only .agents/skills and config files.`,
    nextStep: '\nğŸ‘‰ Run "npx skillink sync" to start syncing!',
  };
}

/**
 * åˆå§‹åŒ–å‘½ä»¤
 * @param cwd å½“å‰å·¥ä½œç›®å½•
 */
export async function initCommand(cwd: string = process.cwd()) {
  const locale = await select<Locale>({
    message: 'Select language / é€‰æ‹©è¯­è¨€',
    choices: [
      { name: 'English', value: 'en' },
      { name: 'ç®€ä½“ä¸­æ–‡', value: 'zh-CN' },
    ],
    default: 'en',
  });
  const text = getInitText(locale);
  const templateSkill = isChineseLocale(locale)
    ? TEMPLATE_SKILL_ZH
    : TEMPLATE_SKILL_EN;

  console.log(text.title);

  const skillsDir = path.join(cwd, '.agents', 'skills');
  const configFile = path.join(cwd, 'skillink.config.ts');

  // 1. åˆ›å»ºæŠ€èƒ½ç›®å½•
  if (!existsSync(skillsDir)) {
    const create = await confirm({
      message: text.createSkillsDir(skillsDir),
      default: true,
    });
    if (create) {
      await ensureDir(skillsDir);
      // åˆ›å»ºç¤ºä¾‹æŠ€èƒ½
      const exampleDir = path.join(skillsDir, 'example-skill');
      await ensureDir(exampleDir);
      await fs.writeFile(path.join(exampleDir, 'SKILL.md'), templateSkill);
      console.log(text.exampleSkillCreated);
    }
  } else {
    console.log(text.skillsDirExists);
  }

  // 2. é€‰æ‹©ç›®æ ‡å·¥å…·
  const selectedTargets = await checkbox({
    message: text.selectTargets,
    choices: DEFAULT_TARGETS.map((t) => ({ name: t.name, value: t })),
  });

  if (selectedTargets.length === 0) {
    console.log(text.noTargets);
  }

  // 3. ç”Ÿæˆé…ç½®æ–‡ä»¶
  if (existsSync(configFile)) {
    const overwrite = await confirm({
      message: text.overwriteConfig,
      default: false,
    });
    if (!overwrite) {
      console.log(text.initCancelled);
      return;
    }
  }

  const configContent = `import { defineConfig } from '@boses/skillink';

export default defineConfig({
  locale: '${locale}',
  source: '.agents/skills',
  targets: [
${selectedTargets
  .map(
    (t) => `    {
      name: '${t.value}',
      path: '${t.path}',
      enabled: true,
    },`,
  )
  .join('\n')}
  ],
});
`;

  await fs.writeFile(configFile, configContent);
  console.log(text.configCreated);
  if (selectedTargets.length > 0) {
    const targetPaths = selectedTargets.map((t) => t.path).join(', ');
    console.log(text.gitAdvice(targetPaths));
  }
  console.log(text.nextStep);
}
